<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Calculate How Much</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Layout shell for calchowmuch.com" />
    <link rel="stylesheet" href="assets/css/base.css?v=20260116" />
    <link rel="stylesheet" href="assets/css/layout.css?v=20260116" />
    <link rel="stylesheet" href="assets/css/calculator.css?v=20260116" />
  </head>
  <body>
    <div class="page">
      <header class="site-header">
        <span>Calculate How Much</span>
      </header>

      <nav class="top-nav" aria-label="Category navigation" id="top-nav"></nav>

      <main class="layout-main">
        <aside class="left-nav" aria-label="Left navigation">
          <h2 class="left-nav-title">Navigation</h2>
          <div id="left-nav-content"></div>
        </aside>

        <section class="center-column">
          <div class="panel panel-scroll">
            <h3 id="calculator-title">Main Calculation Pane</h3>
            <p class="placeholder" id="calculator-placeholder">
              Select a calculator from the navigation list.
            </p>
          </div>
          <div class="panel panel-scroll">
            <h3>Explanation Pane</h3>
            <p class="placeholder" id="explanation-placeholder">
              Explanation content will appear here once you choose a calculator.
            </p>
          </div>
        </section>

        <section class="ads-column" aria-label="Ad placeholders">
          <div class="ad-panel">Ad Pane</div>
        </section>
      </main>

      <footer class="site-footer">
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
        <a href="#">Contact</a>
      </footer>
    </div>
    <script type="module" src="assets/js/core/ui.js"></script>
    <script>
      const state = {
        navigation: null,
        activeCategoryId: null,
        activeCalculatorId: null,
        navSearchQuery: {},
        navCollapsed: {},
      };

      function findCalculatorById(id) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find(calc => calc.id === id);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function findCalculatorByUrl(path) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find(calc => calc.url === path);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function getCalculatorFromLocation() {
        const hashPath = window.location.hash || "";
        if (hashPath) {
          const match = findCalculatorByUrl(hashPath);
          if (match) {
            return match;
          }
        }

        const queryParams = new URLSearchParams(window.location.search);
        const calculatorId = queryParams.get("calculator");
        if (calculatorId) {
          const match = findCalculatorById(calculatorId);
          if (match) {
            return match;
          }
        }

        return null;
      }

      function normalizeSearch(value) {
        return (value ?? "").trim().toLowerCase();
      }

      function getSearchText(calculator) {
        if (!calculator) {
          return "";
        }
        const name = calculator.name ?? "";
        const keywords = Array.isArray(calculator.keywords)
          ? calculator.keywords.join(" ")
          : calculator.keywords ?? "";
        return `${name} ${keywords}`.trim().toLowerCase();
      }

      function getCollapsedMap(categoryId) {
        if (!state.navCollapsed[categoryId]) {
          state.navCollapsed[categoryId] = {};
        }
        return state.navCollapsed[categoryId];
      }

      function applySearchFilter(container, query) {
        const normalizedQuery = normalizeSearch(query);
        const hasQuery = normalizedQuery.length > 0;
        container.classList.toggle("is-searching", hasQuery);

        const categories = Array.from(container.querySelectorAll(".nav-category"));
        categories.forEach(category => {
          const items = Array.from(category.querySelectorAll(".nav-item"));
          let matches = 0;

          items.forEach(item => {
            const text = item.dataset.search ?? "";
            const isMatch = !hasQuery || text.includes(normalizedQuery);
            item.hidden = hasQuery && !isMatch;
            if (isMatch) {
              matches += 1;
            }
          });

          if (!hasQuery) {
            category.hidden = false;
            category.classList.remove("is-search-open");
            return;
          }

          category.hidden = matches === 0;
          category.classList.toggle("is-search-open", matches > 0);
        });
      }

      // Track current module script for cleanup
      let currentModuleScript = null;

      function getCalculatorPath(calculatorId) {
        // Map calculator IDs to folder paths
        const pathMap = {
          'basic': '/calculators/math/basic',
          'percentage-calculator': '/calculators/math/percentage-calculator',
          'percentage-increase': '/calculators/math/percentage-increase',
          'fraction-calculator': '/calculators/math/fraction-calculator',
          'standard-deviation': '/calculators/math/standard-deviation',
          'number-sequence': '/calculators/math/number-sequence',
          'sample-size': '/calculators/math/sample-size',
          'probability': '/calculators/math/probability',
          'statistics': '/calculators/math/statistics',
          'mean-median-mode-range': '/calculators/math/mean-median-mode-range',
          'permutation-combination': '/calculators/math/permutation-combination',
          'z-score': '/calculators/math/z-score',
          'confidence-interval': '/calculators/math/confidence-interval',
          'loan-emi': '/calculators/loans/loan-emi',
          'home-loan': '/calculators/loans/home-loan',
        };
        return pathMap[calculatorId] || null;
      }

      async function loadCalculatorContent(calculator) {
        const calculatorPane = document.querySelector(".center-column .panel:first-child");
        const explanationPane = document.querySelector(".center-column .panel:last-child");

        if (!calculator) {
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Main Calculation Pane</h3>
            <p class="placeholder" id="calculator-placeholder">
              Select a calculator from the navigation list.
            </p>
          `;
          explanationPane.innerHTML = `
            <h3>Explanation Pane</h3>
            <p class="placeholder" id="explanation-placeholder">
              Explanation content will appear here once you choose a calculator.
            </p>
          `;
          return;
        }

        const basePath = getCalculatorPath(calculator.id);
        if (!basePath) {
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Error</h3>
            <p style="color: #dc2626;">Calculator not found. Please try another calculator.</p>
          `;
          return;
        }

        try {
          // Cleanup previous module script
          if (currentModuleScript) {
            currentModuleScript.remove();
            currentModuleScript = null;
          }

          // Load calculator HTML fragment
          const cacheBuster = `t=${Date.now()}`;
          const calculatorResponse = await fetch(`${basePath}/index.html?${cacheBuster}`);
          if (!calculatorResponse.ok) {
            throw new Error(`Failed to load calculator: ${calculatorResponse.status}`);
          }
          const calculatorHTML = await calculatorResponse.text();

          // Load explanation HTML fragment
          const explanationResponse = await fetch(
            `${basePath}/explanation.html?${cacheBuster}`,
          );
          if (!explanationResponse.ok) {
            throw new Error(`Failed to load explanation: ${explanationResponse.status}`);
          }
          const explanationHTML = await explanationResponse.text();

          // Update title and inject calculator HTML
          calculatorPane.innerHTML = `<h3 id="calculator-title">${calculator.name}</h3>` + calculatorHTML;

          // Inject explanation HTML
          explanationPane.innerHTML = `<h3>Explanation</h3>` + explanationHTML;

          // Load and execute module.js
          const moduleScript = document.createElement("script");
          moduleScript.type = "module";
          moduleScript.src = `${basePath}/module.js?t=${Date.now()}`; // Cache bust
          document.body.appendChild(moduleScript);
          currentModuleScript = moduleScript;

        } catch (error) {
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Error</h3>
            <p style="color: #dc2626;">Failed to load calculator. Please try again.</p>
          `;
        }
      }

      function updateUrl(calculator) {
        if (!calculator || !calculator.url) {
          return;
        }

        if (calculator.url.startsWith("#")) {
          window.location.hash = calculator.url;
          return;
        }

        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set("calculator", calculator.id);
        history.pushState({ calculatorId: calculator.id }, "", nextUrl);
      }

      async function setActiveCalculator(calculator, options = {}) {
        state.activeCalculatorId = calculator?.id ?? null;
        await loadCalculatorContent(calculator);
        highlightActiveCalculator();

        if (!options.skipUrlUpdate && calculator) {
          updateUrl(calculator);
        }
      }

      function highlightActiveCalculator() {
        const items = document.querySelectorAll(".nav-item");
        items.forEach(item => {
          item.classList.toggle("is-active", item.dataset.id === state.activeCalculatorId);
        });
      }

      function renderTopNav() {
        const topNav = document.getElementById("top-nav");
        topNav.innerHTML = "";

        state.navigation.categories.forEach(category => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = category.name;
          button.classList.toggle("is-active", category.id === state.activeCategoryId);
          button.addEventListener("click", () => {
            if (state.activeCategoryId === category.id) {
              return;
            }
            state.activeCategoryId = category.id;
            renderTopNav();
            renderLeftNav();
          });
          topNav.appendChild(button);
        });
      }

      function renderLeftNav() {
        const leftNav = document.querySelector(".left-nav");
        const title = document.querySelector(".left-nav-title");
        const container = document.getElementById("left-nav-content");
        container.innerHTML = "";

        const category = state.navigation.categories.find(
          item => item.id === state.activeCategoryId
        );
        if (!category) {
          return;
        }

        const isLoans = category.id === "loans";
        leftNav.classList.toggle("is-loans", isLoans);
        if (title) {
          title.hidden = isLoans;
        }
        if (!isLoans) {
          container.classList.remove("is-searching");
        }

        let searchInput = null;
        if (isLoans) {
          const searchWrap = document.createElement("div");
          searchWrap.className = "nav-search";

          searchInput = document.createElement("input");
          searchInput.type = "search";
          searchInput.className = "nav-search-input";
          searchInput.placeholder = "Search loans...";
          searchInput.setAttribute("aria-label", "Search loan calculators");
          searchInput.value = state.navSearchQuery[category.id] ?? "";
          searchWrap.appendChild(searchInput);
          container.appendChild(searchWrap);
        }

        const collapsedMap = getCollapsedMap(category.id);
        const selectedCalculator = findCalculatorById(state.activeCalculatorId);
        if (selectedCalculator && selectedCalculator.category.id === category.id) {
          collapsedMap[selectedCalculator.subcategory.id] = false;
        }

        category.subcategories.forEach(subcategory => {
          const categoryWrap = document.createElement("div");
          categoryWrap.className = "nav-category";
          categoryWrap.dataset.id = subcategory.id;

          const isCollapsed = collapsedMap[subcategory.id] === true;
          categoryWrap.classList.toggle("is-collapsed", isCollapsed);

          const toggle = document.createElement("button");
          toggle.type = "button";
          toggle.className = "nav-category-toggle";
          toggle.setAttribute("aria-expanded", String(!isCollapsed));

          const label = document.createElement("span");
          label.className = "nav-category-label";
          label.textContent = subcategory.name;

          const indicator = document.createElement("span");
          indicator.className = "nav-category-indicator";
          indicator.textContent = isCollapsed ? "+" : "-";

          toggle.append(label, indicator);
          toggle.addEventListener("click", () => {
            const nextCollapsed = !categoryWrap.classList.contains("is-collapsed");
            categoryWrap.classList.toggle("is-collapsed", nextCollapsed);
            collapsedMap[subcategory.id] = nextCollapsed;
            indicator.textContent = nextCollapsed ? "+" : "-";
            toggle.setAttribute("aria-expanded", String(!nextCollapsed));
          });

          const items = document.createElement("div");
          items.className = "nav-category-items";

          subcategory.calculators.forEach(calculator => {
            const item = document.createElement("button");
            item.type = "button";
            item.className = "nav-item";
            item.textContent = calculator.name;
            item.dataset.id = calculator.id;

            const searchText = getSearchText(calculator);
            if (searchText) {
              item.dataset.search = searchText;
            }

            item.addEventListener("click", () => {
              setActiveCalculator(calculator);
            });
            items.appendChild(item);
          });

          categoryWrap.append(toggle, items);
          container.appendChild(categoryWrap);
        });

        const selected = findCalculatorById(state.activeCalculatorId);
        if (!selected || selected.category.id !== category.id) {
          const firstCalculator = category.subcategories
            .map(subcategory => subcategory.calculators[0])
            .find(Boolean);

          if (firstCalculator) {
            setActiveCalculator(firstCalculator, { skipUrlUpdate: true });
          } else {
            setActiveCalculator(null, { skipUrlUpdate: true });
          }
        }

        highlightActiveCalculator();

        if (isLoans && searchInput) {
          searchInput.addEventListener("input", () => {
            const query = searchInput.value;
            state.navSearchQuery[category.id] = query;
            applySearchFilter(container, query);
          });
          applySearchFilter(container, searchInput.value);
        }

        leftNav.scrollTop = 0;
      }

      function handleNavigationChange() {
        const match = getCalculatorFromLocation();
        if (match) {
          state.activeCategoryId = match.category.id;
          renderTopNav();
          renderLeftNav();
          setActiveCalculator(match.calculator, { skipUrlUpdate: true });
        }
      }

      async function initializeNavigation() {
        try {
          const response = await fetch("config/navigation.json");
          state.navigation = await response.json();

          const initialMatch = getCalculatorFromLocation();
          if (initialMatch) {
            state.activeCategoryId = initialMatch.category.id;
            state.activeCalculatorId = initialMatch.calculator.id;
          } else {
            state.activeCategoryId = state.navigation.categories[0]?.id ?? null;
          }

          renderTopNav();
          renderLeftNav();

          if (initialMatch) {
            setActiveCalculator(initialMatch.calculator, { skipUrlUpdate: true });
          }
        } catch (error) {
          console.error("Unable to load navigation.json", error);
        }
      }

      window.addEventListener("popstate", handleNavigationChange);
      window.addEventListener("hashchange", handleNavigationChange);
      document.addEventListener("DOMContentLoaded", initializeNavigation);
    </script>
  </body>
</html>

