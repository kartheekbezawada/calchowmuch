<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Calculate How Much</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Layout shell for calchowmuch.com" />
    <link rel="stylesheet" href="assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/layout.css" />
  </head>
  <body>
    <div class="page">
      <header class="site-header">
        <span>Calculate How Much</span>
      </header>

      <nav class="top-nav" aria-label="Category navigation" id="top-nav"></nav>

      <main class="layout-main">
        <aside class="left-nav" aria-label="Left navigation">
          <h2>Navigation</h2>
          <div id="left-nav-content"></div>
        </aside>

        <section class="center-column">
          <div class="panel">
            <h3 id="calculator-title">Main Calculation Pane</h3>
            <p class="placeholder" id="calculator-placeholder">
              Select a calculator from the navigation list.
            </p>
          </div>
          <div class="panel">
            <h3>Explanation Pane</h3>
            <p class="placeholder" id="explanation-placeholder">
              Explanation content will appear here once you choose a calculator.
            </p>
          </div>
        </section>

        <section class="ads-column" aria-label="Ad placeholders">
          <div class="ad-panel">Ad Pane</div>
          <div class="ad-panel">Ad Pane</div>
        </section>
      </main>

      <footer class="site-footer">
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
        <a href="#">Contact</a>
      </footer>
    </div>
    <script>
      const state = {
        navigation: null,
        activeCategoryId: null,
        activeCalculatorId: null,
        loadedModuleScript: null, // Track loaded module script for cleanup
      };

      function findCalculatorById(id) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find(calc => calc.id === id);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function findCalculatorByUrl(path) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find(calc => calc.url === path);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function getCalculatorFromLocation() {
        const hashPath = window.location.hash || "";
        if (hashPath) {
          const match = findCalculatorByUrl(hashPath);
          if (match) {
            return match;
          }
        }

        const queryParams = new URLSearchParams(window.location.search);
        const calculatorId = queryParams.get("calculator");
        if (calculatorId) {
          const match = findCalculatorById(calculatorId);
          if (match) {
            return match;
          }
        }

        return null;
      }

      function cleanupPreviousCalculator() {
        // Remove previous module script if it exists
        if (state.loadedModuleScript) {
          state.loadedModuleScript.remove();
          state.loadedModuleScript = null;
        }

        // Remove any dynamically added calculator styles
        const existingStyles = document.querySelectorAll('style[data-calculator-style]');
        existingStyles.forEach(style => style.remove());
      }

      function getCalculatorPath(calculatorId, categoryId) {
        // Map calculator IDs to their folder paths
        // Assuming calculators are in /calculators/{category}/{calculator-id}/
        return `calculators/${categoryId}/${calculatorId}`;
      }

      async function loadCalculator(calculator, category) {
        const title = document.getElementById("calculator-title");
        const calculatorPlaceholder = document.getElementById("calculator-placeholder");
        const explanationPlaceholder = document.getElementById("explanation-placeholder");

        if (!calculator) {
          cleanupPreviousCalculator();
          title.textContent = "Main Calculation Pane";
          calculatorPlaceholder.innerHTML = "<p class='placeholder'>Select a calculator from the navigation list.</p>";
          explanationPlaceholder.innerHTML = "<p class='placeholder'>Explanation content will appear here once you choose a calculator.</p>";
          return;
        }

        // Clean up previous calculator
        cleanupPreviousCalculator();

        // Update title
        title.textContent = calculator.name;

        // Get calculator path
        const basePath = getCalculatorPath(calculator.id, category.id);

        try {
          // Load calculator HTML fragment
          const calculatorResponse = await fetch(`${basePath}/index.html`);
          if (!calculatorResponse.ok) {
            throw new Error(`Failed to load calculator: ${calculatorResponse.status}`);
          }
          const calculatorHtml = await calculatorResponse.text();

          // Parse the HTML to extract styles and content separately
          const parser = new DOMParser();
          const doc = parser.parseFromString(calculatorHtml, 'text/html');

          // Extract and inject styles
          const styleElements = doc.querySelectorAll('style');
          styleElements.forEach(styleEl => {
            const newStyle = document.createElement('style');
            newStyle.textContent = styleEl.textContent;
            newStyle.setAttribute('data-calculator-style', 'true');
            document.head.appendChild(newStyle);
          });

          // Extract all non-style content from body
          const contentDiv = document.createElement('div');
          Array.from(doc.body.childNodes).forEach(node => {
            if (node.nodeType === Node.ELEMENT_NODE && node.tagName.toLowerCase() === 'style') {
              return; // Skip style tags
            }
            contentDiv.appendChild(node.cloneNode(true));
          });

          // Inject calculator content
          calculatorPlaceholder.innerHTML = contentDiv.innerHTML;

          // Load explanation HTML
          const explanationResponse = await fetch(`${basePath}/explanation.html`);
          if (!explanationResponse.ok) {
            throw new Error(`Failed to load explanation: ${explanationResponse.status}`);
          }
          const explanationHtml = await explanationResponse.text();
          explanationPlaceholder.innerHTML = explanationHtml;

          // Load module script
          const script = document.createElement('script');
          script.type = 'module';
          script.src = `${basePath}/module.js`;
          script.onerror = () => {
            console.error(`Failed to load module: ${basePath}/module.js`);
          };
          document.body.appendChild(script);
          state.loadedModuleScript = script;

        } catch (error) {
          console.error('Error loading calculator:', error);
          calculatorPlaceholder.innerHTML = `<p style="color: #dc2626;">Error loading calculator: ${error.message}</p>`;
          explanationPlaceholder.innerHTML = `<p style="color: #dc2626;">Error loading explanation.</p>`;
        }
      }

      function updateUrl(calculator) {
        if (!calculator || !calculator.url) {
          return;
        }

        if (calculator.url.startsWith("#")) {
          window.location.hash = calculator.url;
          return;
        }

        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set("calculator", calculator.id);
        history.pushState({ calculatorId: calculator.id }, "", nextUrl);
      }

      async function setActiveCalculator(calculator, options = {}) {
        state.activeCalculatorId = calculator?.id ?? null;

        // Find the category for this calculator
        const match = calculator ? findCalculatorById(calculator.id) : null;
        const category = match ? match.category : null;

        await loadCalculator(calculator, category);
        highlightActiveCalculator();

        if (!options.skipUrlUpdate && calculator) {
          updateUrl(calculator);
        }
      }

      function highlightActiveCalculator() {
        const items = document.querySelectorAll(".nav-item");
        items.forEach(item => {
          item.classList.toggle("is-active", item.dataset.id === state.activeCalculatorId);
        });
      }

      function renderTopNav() {
        const topNav = document.getElementById("top-nav");
        topNav.innerHTML = "";

        state.navigation.categories.forEach(category => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = category.name;
          button.classList.toggle("is-active", category.id === state.activeCategoryId);
          button.addEventListener("click", () => {
            if (state.activeCategoryId === category.id) {
              return;
            }
            state.activeCategoryId = category.id;
            renderTopNav();
            renderLeftNav();
          });
          topNav.appendChild(button);
        });
      }

      function renderLeftNav() {
        const container = document.getElementById("left-nav-content");
        container.innerHTML = "";

        const category = state.navigation.categories.find(
          item => item.id === state.activeCategoryId
        );
        if (!category) {
          return;
        }

        category.subcategories.forEach(subcategory => {
          const subcategoryTitle = document.createElement("h3");
          subcategoryTitle.textContent = subcategory.name;
          subcategoryTitle.className = "subcategory-title";
          container.appendChild(subcategoryTitle);

          subcategory.calculators.forEach(calculator => {
            const item = document.createElement("button");
            item.type = "button";
            item.className = "nav-item";
            item.textContent = calculator.name;
            item.dataset.id = calculator.id;
            item.addEventListener("click", () => {
              setActiveCalculator(calculator);
            });
            container.appendChild(item);
          });
        });

        const selectedCalculator = findCalculatorById(state.activeCalculatorId);
        if (!selectedCalculator || selectedCalculator.category.id !== category.id) {
          const firstCalculator =
            category.subcategories[0]?.calculators[0] ?? null;
          if (firstCalculator) {
            setActiveCalculator(firstCalculator, { skipUrlUpdate: true });
          }
        }

        highlightActiveCalculator();
      }

      function handleNavigationChange() {
        const match = getCalculatorFromLocation();
        if (match) {
          state.activeCategoryId = match.category.id;
          renderTopNav();
          renderLeftNav();
          setActiveCalculator(match.calculator, { skipUrlUpdate: true });
        }
      }

      async function initializeNavigation() {
        try {
          const response = await fetch("config/navigation.json");
          state.navigation = await response.json();

          const initialMatch = getCalculatorFromLocation();
          if (initialMatch) {
            state.activeCategoryId = initialMatch.category.id;
            state.activeCalculatorId = initialMatch.calculator.id;
          } else {
            state.activeCategoryId = state.navigation.categories[0]?.id ?? null;
          }

          renderTopNav();
          renderLeftNav();

          if (initialMatch) {
            setActiveCalculator(initialMatch.calculator, { skipUrlUpdate: true });
          }
        } catch (error) {
          console.error("Unable to load navigation.json", error);
        }
      }

      window.addEventListener("popstate", handleNavigationChange);
      window.addEventListener("hashchange", handleNavigationChange);
      document.addEventListener("DOMContentLoaded", initializeNavigation);
    </script>
  </body>
</html>
