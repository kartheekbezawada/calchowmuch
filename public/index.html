<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Calculate How Much</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Layout shell for calchowmuch.com" />
    <link rel="stylesheet" href="assets/css/base.css?v=20260116" />
    <link rel="stylesheet" href="assets/css/layout.css?v=20260116" />
    <link rel="stylesheet" href="assets/css/calculator.css?v=20260116" />
  </head>
  <body>
    <div class="page">
      <header class="site-header">
        <div class="header-content">
          <h1>Calculate How Much</h1>
          <p class="site-tagline">Calculate how much you need, spend, afford.</p>
        </div>
        <div class="header-controls">
          <div class="theme-toggle" id="theme-toggle" role="switch" aria-checked="false" aria-label="Toggle theme">
            <div class="theme-toggle-slider">‚òÄÔ∏è</div>
          </div>
          <div class="header-icon" aria-label="Settings">‚öôÔ∏è</div>
        </div>
      </header>

      <nav class="top-nav" aria-label="Category navigation" id="top-nav" data-testid="top-nav"></nav>

      <main class="layout-main">
        <aside class="left-nav" aria-label="Left navigation">
          <h2 class="left-nav-title">Navigation</h2>
          <div id="left-nav-content"></div>
        </aside>

        <section class="center-column">
          <div class="panel panel-scroll">
            <h3 id="calculator-title">Main Calculation Pane</h3>
            <p class="placeholder" id="calculator-placeholder">
              Select a calculator from the navigation list.
            </p>
          </div>
          <div class="panel panel-scroll">
            <h3>Explanation Pane</h3>
            <p class="placeholder" id="explanation-placeholder">
              Explanation content will appear here once you choose a calculator.
            </p>
          </div>
        </section>

        <section class="ads-column" aria-label="Ad placeholders">
          <div class="ad-panel">Ad Pane</div>
        </section>
      </main>

      <footer class="site-footer">
        <div class="footer-content">
          <a href="#" class="footer-link">Privacy</a>
          <span class="footer-divider">|</span>
          <a href="#" class="footer-link">Terms & Conditions</a>
          <span class="footer-divider">|</span>
          <a href="#" class="footer-link">Contact</a>
          <span class="footer-divider">|</span>
          <a href="#" class="footer-link">FAQs</a>
          <span class="footer-divider">|</span>
          <span class="footer-branding">¬© 2026 <span class="brand-name">@CalcHowMuch</span></span>
        </div>
      </footer>
    </div>
    <script type="module" src="assets/js/core/ui.js"></script>
    <script type="module">
      import { resetPageMetadata } from './assets/js/core/ui.js';
      import { initThemeToggle } from './assets/js/core/theme.js';

      // Initialize theme toggle
      initThemeToggle();

      const state = {
        navigation: null,
        activeCategoryId: null,
        activeSubcategoryId: null,
        activeCalculatorId: null,
        navSearchQuery: {},
        navCollapsed: {},
      };

      function findCalculatorById(id) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find((calc) => calc.id === id);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function findCalculatorByUrl(path) {
        if (!state.navigation) {
          return null;
        }

        for (const category of state.navigation.categories) {
          for (const subcategory of category.subcategories) {
            const calculator = subcategory.calculators.find((calc) => calc.url === path);
            if (calculator) {
              return { category, subcategory, calculator };
            }
          }
        }

        return null;
      }

      function getCalculatorFromLocation() {
        const hashPath = window.location.hash || '';
        if (hashPath) {
          const match = findCalculatorByUrl(hashPath);
          if (match) {
            return match;
          }
        }

        const queryParams = new URLSearchParams(window.location.search);
        const calculatorId = queryParams.get('calculator');
        if (calculatorId) {
          const match = findCalculatorById(calculatorId);
          if (match) {
            return match;
          }
        }

        return null;
      }

      function normalizeSearch(value) {
        return (value ?? '').trim().toLowerCase();
      }

      function getSearchText(calculator) {
        if (!calculator) {
          return '';
        }
        const name = calculator.name ?? '';
        const keywords = Array.isArray(calculator.keywords)
          ? calculator.keywords.join(' ')
          : (calculator.keywords ?? '');
        return `${name} ${keywords}`.trim().toLowerCase();
      }

      function getCollapsedMap(categoryId) {
        if (!state.navCollapsed[categoryId]) {
          state.navCollapsed[categoryId] = {};
        }
        return state.navCollapsed[categoryId];
      }

      function applySearchFilter(container, query) {
        const normalizedQuery = normalizeSearch(query);
        const hasQuery = normalizedQuery.length > 0;
        container.classList.toggle('is-searching', hasQuery);

        const categories = Array.from(container.querySelectorAll('.nav-category'));
        categories.forEach((category) => {
          const items = Array.from(category.querySelectorAll('.nav-item'));
          let matches = 0;

          items.forEach((item) => {
            const text = item.dataset.search ?? '';
            const isMatch = !hasQuery || text.includes(normalizedQuery);
            item.hidden = hasQuery && !isMatch;
            if (isMatch) {
              matches += 1;
            }
          });

          if (!hasQuery) {
            category.hidden = false;
            category.classList.remove('is-search-open');
            return;
          }

          category.hidden = matches === 0;
          category.classList.toggle('is-search-open', matches > 0);
        });
      }

      // Track current module script for cleanup
      let currentModuleScript = null;

      function getCalculatorPath(calculatorId) {
        // Map calculator IDs to folder paths
        const pathMap = {
          basic: '/calculators/math/basic',
          'percentage-calculator': '/calculators/math/percentage-calculator',
          'percentage-increase': '/calculators/math/percentage-increase',
          'fraction-calculator': '/calculators/math/fraction-calculator',
          'quadratic-equation': '/calculators/math/algebra/quadratic-equation',
          'system-of-equations': '/calculators/math/algebra/system-of-equations',
          'polynomial-operations': '/calculators/math/algebra/polynomial-operations',
          factoring: '/calculators/math/algebra/factoring',
          'slope-distance': '/calculators/math/algebra/slope-distance',
          'unit-circle': '/calculators/math/trigonometry/unit-circle',
          'triangle-solver': '/calculators/math/trigonometry/triangle-solver',
          'trig-functions': '/calculators/math/trigonometry/trig-functions',
          'inverse-trig': '/calculators/math/trigonometry/inverse-trig',
          'law-of-sines-cosines': '/calculators/math/trigonometry/law-of-sines-cosines',
          'derivative': '/calculators/math/calculus/derivative',
          'integral': '/calculators/math/calculus/integral',
          'limit': '/calculators/math/calculus/limit',
          'series-convergence': '/calculators/math/calculus/series-convergence',
          'critical-points': '/calculators/math/calculus/critical-points',
          'natural-log': '/calculators/math/log/natural-log',
          'common-log': '/calculators/math/log/common-log',
          'log-properties': '/calculators/math/log/log-properties',
          'exponential-equations': '/calculators/math/log/exponential-equations',
          'log-scale': '/calculators/math/log/log-scale',
          'standard-deviation': '/calculators/math/standard-deviation',
          'number-sequence': '/calculators/math/number-sequence',
          'sample-size': '/calculators/math/sample-size',
          probability: '/calculators/math/probability',
          statistics: '/calculators/math/statistics',
          'mean-median-mode-range': '/calculators/math/mean-median-mode-range',
          'permutation-combination': '/calculators/math/permutation-combination',
          'z-score': '/calculators/math/z-score',
          'confidence-interval': '/calculators/math/confidence-interval',
          'loan-emi': '/calculators/loans/loan-emi',
          'home-loan': '/calculators/loans/home-loan',
          'how-much-can-borrow': '/calculators/loans/how-much-can-borrow',
          'remortgage-switching': '/calculators/loans/remortgage-switching',
          'buy-to-let': '/calculators/loans/buy-to-let',
          'overpayment-additional-payment': '/calculators/loans/overpayment-additional-payment',
          'offset-calculator': '/calculators/loans/offset-calculator',
          'interest-rate-change-calculator': '/calculators/loans/interest-rate-change-calculator',
          'loan-to-value': '/calculators/loans/loan-to-value',
          'credit-card-repayment-payoff': '/calculators/loans/credit-card-repayment-payoff',
          'credit-card-minimum-payment': '/calculators/loans/credit-card-minimum-payment',
          'balance-transfer-installment-plan':
            '/calculators/loans/balance-transfer-installment-plan',
          'credit-card-consolidation': '/calculators/loans/credit-card-consolidation',
          'car-loan': '/calculators/loans/car-loan',
          'multiple-car-loan': '/calculators/loans/multiple-car-loan',
          'hire-purchase': '/calculators/loans/hire-purchase',
          'pcp-calculator': '/calculators/loans/pcp-calculator',
          'leasing-calculator': '/calculators/loans/leasing-calculator',
        };
        return pathMap[calculatorId] || null;
      }

      async function loadCalculatorContent(calculator) {
        const calculatorPane = document.querySelector('.center-column .panel:first-child');
        const explanationPane = document.querySelector('.center-column .panel:last-child');

        if (!calculator) {
          resetPageMetadata();
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Main Calculation Pane</h3>
            <p class="placeholder" id="calculator-placeholder">
              Select a calculator from the navigation list.
            </p>
          `;
          explanationPane.innerHTML = `
            <h3>Explanation Pane</h3>
            <p class="placeholder" id="explanation-placeholder">
              Explanation content will appear here once you choose a calculator.
            </p>
          `;
          return;
        }

        resetPageMetadata();
        const basePath = getCalculatorPath(calculator.id);
        if (!basePath) {
          resetPageMetadata();
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Error</h3>
            <p style="color: #dc2626;">Calculator not found. Please try another calculator.</p>
          `;
          return;
        }

        try {
          // Cleanup previous module script
          if (currentModuleScript) {
            currentModuleScript.remove();
            currentModuleScript = null;
          }

          // Load calculator HTML fragment
          const cacheBuster = `t=${Date.now()}`;
          const calculatorResponse = await fetch(`${basePath}/index.html?${cacheBuster}`);
          if (!calculatorResponse.ok) {
            throw new Error(`Failed to load calculator: ${calculatorResponse.status}`);
          }
          const calculatorHTML = await calculatorResponse.text();

          // Load explanation HTML fragment
          const explanationResponse = await fetch(`${basePath}/explanation.html?${cacheBuster}`);
          if (!explanationResponse.ok) {
            throw new Error(`Failed to load explanation: ${explanationResponse.status}`);
          }
          const explanationHTML = await explanationResponse.text();

          // Update title and inject calculator HTML
          calculatorPane.innerHTML =
            `<h3 id="calculator-title">${calculator.name}</h3>` + calculatorHTML;

          // Inject explanation HTML
          explanationPane.innerHTML = `<h3>Explanation</h3>` + explanationHTML;

          // Load and execute module.js
          const moduleScript = document.createElement('script');
          moduleScript.type = 'module';
          moduleScript.src = `${basePath}/module.js?t=${Date.now()}`; // Cache bust
          document.body.appendChild(moduleScript);
          currentModuleScript = moduleScript;
        } catch (error) {
          resetPageMetadata();
          calculatorPane.innerHTML = `
            <h3 id="calculator-title">Error</h3>
            <p style="color: #dc2626;">Failed to load calculator. Please try again.</p>
          `;
        }
      }

      function updateUrl(calculator) {
        if (!calculator || !calculator.url) {
          return;
        }

        if (calculator.url.startsWith('#')) {
          const nextUrl = new URL(window.location.href);
          nextUrl.hash = calculator.url;
          history.pushState({ calculatorId: calculator.id }, '', nextUrl);
          return;
        }

        const nextUrl = new URL(window.location.href);
        nextUrl.searchParams.set('calculator', calculator.id);
        history.pushState({ calculatorId: calculator.id }, '', nextUrl);
      }

      async function setActiveCalculator(calculator, options = {}) {
        state.activeCalculatorId = calculator?.id ?? null;
        await loadCalculatorContent(calculator);
        highlightActiveCalculator();

        if (!options.skipUrlUpdate && calculator) {
          updateUrl(calculator);
        }
      }

      function highlightActiveCalculator() {
        const items = document.querySelectorAll('.nav-item');
        items.forEach((item) => {
          item.classList.toggle('is-active', item.dataset.id === state.activeCalculatorId);
        });
      }

      function getFlattenedNavItems() {
        if (!state.navigation) {
          return [];
        }

        const items = [];

        state.navigation.categories.forEach((category) => {
          if (category.id === 'loans') {
            category.subcategories.forEach((subcategory) => {
              items.push({
                id: `${category.id}:${subcategory.id}`,
                categoryId: category.id,
                subcategoryId: subcategory.id,
                name: subcategory.name === 'Home' ? 'Home Loan' : subcategory.name,
                subcategory: subcategory,
              });
            });
          } else {
            items.push({
              id: category.id,
              categoryId: category.id,
              subcategoryId: null,
              name: category.name,
              category: category,
            });
          }
        });

        return items;
      }

      function getCurrentNavItemId() {
        if (state.activeSubcategoryId) {
          return `${state.activeCategoryId}:${state.activeSubcategoryId}`;
        }
        return state.activeCategoryId;
      }

      function renderTopNav() {
        const topNav = document.getElementById('top-nav');
        topNav.innerHTML = '';

        // Icon mapping for categories
        const iconMap = {
          'math': 'üìê',
          'home': 'üè†',
          'credit-cards': 'üí≥',
          'auto-loans': 'üöó',
          'personal': 'üí∞'
        };

        const navItems = getFlattenedNavItems();
        const currentId = getCurrentNavItemId();

        navItems.forEach((item) => {
          const button = document.createElement('button');
          button.type = 'button';

          // Add icon if available
          const icon = iconMap[item.categoryId] || iconMap[item.id] || '';
          if (icon) {
            button.innerHTML = `<span class="icon">${icon}</span><span>${item.name}</span>`;
          } else {
            button.textContent = item.name;
          }

          button.classList.toggle('is-active', item.id === currentId);
          button.setAttribute('data-testid', 'top-nav-btn');
          button.setAttribute('data-nav-id', item.id.replace('loans:', ''));
          button.addEventListener('click', () => {
            if (item.id === currentId) {
              return;
            }
            state.activeCategoryId = item.categoryId;
            state.activeSubcategoryId = item.subcategoryId;
            renderTopNav();
            renderLeftNav();
          });
          topNav.appendChild(button);
        });
      }

      function renderLeftNav() {
        const leftNav = document.querySelector('.left-nav');
        const title = document.querySelector('.left-nav-title');
        const container = document.getElementById('left-nav-content');
        container.innerHTML = '';

        const category = state.navigation.categories.find(
          (item) => item.id === state.activeCategoryId
        );
        if (!category) {
          return;
        }

        if (title) {
          title.hidden = false;
        }
        container.classList.remove('is-searching');

        let subcategoriesToRender = category.subcategories;
        let displayName = category.name ?? 'calculators';

        if (state.activeSubcategoryId) {
          const activeSubcategory = category.subcategories.find(
            (sub) => sub.id === state.activeSubcategoryId
          );
          if (activeSubcategory) {
            subcategoriesToRender = [activeSubcategory];
            displayName = activeSubcategory.name === 'Home' ? 'Home Loan' : activeSubcategory.name;
          }
        }

        const searchWrap = document.createElement('div');
        searchWrap.className = 'nav-search';

        const searchInput = document.createElement('input');
        const searchId = `nav-search-${state.activeSubcategoryId || category.id}`;
        searchInput.type = 'search';
        searchInput.className = 'nav-search-input';
        searchInput.id = searchId;
        searchInput.placeholder = `Search ${displayName.toLowerCase()}...`;
        searchInput.setAttribute('aria-label', `Search ${displayName} calculators`);
        searchInput.value = state.navSearchQuery[searchId] ?? '';
        const searchLabel = document.createElement('label');
        searchLabel.className = 'sr-only';
        searchLabel.setAttribute('for', searchId);
        searchLabel.textContent = `Search ${displayName} calculators`;
        searchWrap.append(searchLabel, searchInput);
        container.appendChild(searchWrap);

        const collapsedMapKey = state.activeSubcategoryId || category.id;
        const collapsedMap = getCollapsedMap(collapsedMapKey);
        const selectedCalculator = findCalculatorById(state.activeCalculatorId);
        if (selectedCalculator && selectedCalculator.category.id === category.id) {
          collapsedMap[selectedCalculator.subcategory.id] = false;
        }

        subcategoriesToRender.forEach((subcategory) => {
          const categoryWrap = document.createElement('div');
          categoryWrap.className = 'nav-category';
          categoryWrap.dataset.id = subcategory.id;

          const isCollapsed = collapsedMap[subcategory.id] === true;
          categoryWrap.classList.toggle('is-collapsed', isCollapsed);

          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'nav-category-toggle';
          toggle.setAttribute('aria-expanded', String(!isCollapsed));

          const label = document.createElement('span');
          label.className = 'nav-category-label';
          label.textContent = subcategory.name;

          const indicator = document.createElement('span');
          indicator.className = 'nav-category-indicator';
          indicator.textContent = isCollapsed ? '+' : '-';

          toggle.append(label, indicator);
          toggle.addEventListener('click', () => {
            const nextCollapsed = !categoryWrap.classList.contains('is-collapsed');
            categoryWrap.classList.toggle('is-collapsed', nextCollapsed);
            collapsedMap[subcategory.id] = nextCollapsed;
            indicator.textContent = nextCollapsed ? '+' : '-';
            toggle.setAttribute('aria-expanded', String(!nextCollapsed));
          });

          const items = document.createElement('div');
          items.className = 'nav-category-items';

          subcategory.calculators.forEach((calculator) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'nav-item';
            item.textContent = calculator.name;
            item.dataset.id = calculator.id;

            const searchText = getSearchText(calculator);
            if (searchText) {
              item.dataset.search = searchText;
            }

            item.addEventListener('click', () => {
              setActiveCalculator(calculator);
            });
            items.appendChild(item);
          });

          categoryWrap.append(toggle, items);
          container.appendChild(categoryWrap);
        });

        const selected = findCalculatorById(state.activeCalculatorId);
        const needsNewCalculator =
          !selected ||
          selected.category.id !== category.id ||
          (state.activeSubcategoryId && selected.subcategory.id !== state.activeSubcategoryId);

        if (needsNewCalculator) {
          const firstCalculator = subcategoriesToRender
            .map((subcategory) => subcategory.calculators[0])
            .find(Boolean);

          if (firstCalculator) {
            setActiveCalculator(firstCalculator, { skipUrlUpdate: true });
          } else {
            setActiveCalculator(null, { skipUrlUpdate: true });
          }
        }

        highlightActiveCalculator();

        searchInput.addEventListener('input', () => {
          const query = searchInput.value;
          state.navSearchQuery[searchId] = query;
          applySearchFilter(container, query);
        });
        applySearchFilter(container, searchInput.value);

        leftNav.scrollTop = 0;
      }

      function handleNavigationChange() {
        const match = getCalculatorFromLocation();
        if (!match) {
          return;
        }

        const nextCategoryId = match.category.id;
        const nextSubcategoryId = nextCategoryId === 'loans' ? match.subcategory.id : null;
        const nextCalculatorId = match.calculator.id;
        const categoryChanged = nextCategoryId !== state.activeCategoryId;
        const subcategoryChanged = nextSubcategoryId !== state.activeSubcategoryId;
        const calculatorChanged = nextCalculatorId !== state.activeCalculatorId;

        if (!categoryChanged && !subcategoryChanged && !calculatorChanged) {
          return;
        }

        state.activeCategoryId = nextCategoryId;
        state.activeSubcategoryId = nextSubcategoryId;
        state.activeCalculatorId = nextCalculatorId;

        if (categoryChanged || subcategoryChanged) {
          renderTopNav();
          renderLeftNav();
        }

        setActiveCalculator(match.calculator, { skipUrlUpdate: true });
      }

      async function initializeNavigation() {
        try {
          const response = await fetch('config/navigation.json');
          state.navigation = await response.json();

          const initialMatch = getCalculatorFromLocation();
          if (initialMatch) {
            state.activeCategoryId = initialMatch.category.id;
            state.activeSubcategoryId =
              initialMatch.category.id === 'loans' ? initialMatch.subcategory.id : null;
            state.activeCalculatorId = initialMatch.calculator.id;
          } else {
            state.activeCategoryId = state.navigation.categories[0]?.id ?? null;
            state.activeSubcategoryId = null;
          }

          renderTopNav();
          renderLeftNav();

          if (initialMatch) {
            setActiveCalculator(initialMatch.calculator, { skipUrlUpdate: true });
          }
        } catch (error) {
          console.error('Unable to load navigation.json', error);
        }
      }

      window.addEventListener('popstate', handleNavigationChange);
      window.addEventListener('hashchange', handleNavigationChange);
      document.addEventListener('DOMContentLoaded', initializeNavigation);
    </script>
  </body>
</html>
